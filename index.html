<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEXCOMERCIAL S.A. | Gesti贸n de Devoluciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .glass-card { background: white; border-radius: 20px; box-shadow: 0 15px 35px -5px rgba(0,0,0,0.05); }
        .input-field { border-bottom: 2px solid #e2e8f0; transition: all 0.3s; padding: 8px; outline: none; width: 100%; }
        .input-field:focus { border-color: #2563eb; background: #f0f7ff; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <nav class="bg-slate-900 text-white p-4 mb-8 shadow-xl">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 px-3 py-1 rounded-lg font-black text-xl italic">TX</div>
                <h1 class="font-extrabold text-lg tracking-tight">TEXCOMERCIAL S.A.</h1>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-slate-400 font-bold uppercase">Folio Digital</p>
                <p id="consecutivoDisplay" class="text-blue-400 font-mono font-bold text-xl">...</p>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 space-y-8">
        
        <main class="glass-card overflow-hidden">
            <div class="bg-blue-600 p-4 text-white text-xs font-black uppercase tracking-widest flex justify-between">
                <span>Registro de Mercader铆a</span>
                <span id="fechaActual"></span>
            </div>

            <form id="formDevolucion" class="p-8 space-y-10">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Cliente</label>
                        <input type="text" id="cliente" class="input-field font-bold text-slate-700" placeholder="Nombre completo" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">R.U.C.</label>
                        <input type="text" id="ruc" class="input-field" placeholder="17xxxxxxxx001">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Ciudad</label>
                        <input type="text" id="ciudad" class="input-field" placeholder="Ej: Quito">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Vendedor</label>
                        <input type="text" id="vendedor" class="input-field">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Direcci贸n Exacta</label>
                        <input type="text" id="direccion" class="input-field" placeholder="Calles y Referencia">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Bodega Destino</label>
                        <select id="bodega" class="input-field font-semibold">
                            <option value="Bodega #1">Bodega #1 (Matriz)</option>
                            <option value="Bodega #3">Bodega #3 (Sucursal)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Fecha</label>
                        <input type="date" id="fecha" class="input-field">
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-sm font-black text-slate-800 border-b pb-2 uppercase italic tracking-tighter">Detalle de Devoluci贸n</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="tablaArticulos">
                            <thead class="text-[10px] uppercase text-slate-400 font-black">
                                <tr>
                                    <th class="p-3">C贸d</th>
                                    <th class="p-3">Descripci贸n</th>
                                    <th class="p-3 text-center">Cant.</th>
                                    <th class="p-3 text-center">Motivo</th>
                                    <th class="p-3 text-center">Empaque</th>
                                    <th class="p-3 text-center">Evidencia</th>
                                    <th class="p-3 text-center">Factura</th>
                                    <th class="p-3"></th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoTabla" class="divide-y divide-slate-100">
                                <tr class="item-fila">
                                    <td class="p-2"><input type="text" class="w-16 font-mono text-blue-600 outline-none" placeholder="001"></td>
                                    <td class="p-2"><input type="text" class="w-full font-semibold outline-none" placeholder="Art铆culo"></td>
                                    <td class="p-2"><input type="number" class="w-12 text-center outline-none" value="1"></td>
                                    <td class="p-2">
                                        <select class="text-[10px] outline-none bg-transparent">
                                            <option>Rotura</option><option>Vencimiento</option><option>Error Despacho</option><option>Mal Estado</option>
                                        </select>
                                    </td>
                                    <td class="p-2">
                                        <select class="text-[10px] outline-none bg-transparent font-bold text-slate-500">
                                            <option>Original</option><option>Abierto</option><option>Da帽ado</option><option>Sin Caja</option>
                                        </select>
                                    </td>
                                    <td class="p-2">
                                        <div class="flex flex-col items-center">
                                            <label class="cursor-pointer bg-slate-100 p-2 rounded-full hover:bg-blue-100 transition-all">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><circle cx="12" cy="13" r="3" /></svg>
                                                <input type="file" accept="image/*" capture="environment" class="hidden" onchange="procesarFoto(this)">
                                            </label>
                                            <img src="" class="img-preview hidden w-8 h-8 object-cover rounded mt-1" data-base64="">
                                        </div>
                                    </td>
                                    <td class="p-2"><input type="text" class="w-20 text-center font-mono uppercase outline-none" placeholder="F-00"></td>
                                    <td class="p-2"><button type="button" onclick="eliminarFila(this)" class="text-red-300 hover:text-red-600 font-bold"></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="button" onclick="agregarFila()" class="text-[10px] font-black text-blue-600 uppercase tracking-widest">+ Agregar Producto</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-6">
                    <div class="border-t pt-4 text-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase">Firma Emisor</p>
                    </div>
                    <div class="border-t pt-4 text-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase">Firma Transporte</p>
                    </div>
                    <div class="border-t pt-4 text-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase">Firma Cliente</p>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="button" onclick="guardarRegistro()" id="btnGuardar" class="flex-1 bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-blue-600 transition-all uppercase text-sm tracking-widest">Guardar y Descargar Acta PDF</button>
                    <button type="button" onclick="location.reload()" id="btnCancelar" class="hidden bg-slate-100 text-slate-400 px-8 rounded-2xl font-bold uppercase text-xs">Cancelar</button>
                </div>
            </form>
        </main>

        <section id="adminPanel" class="hidden glass-card p-8 border-t-8 border-slate-900">
            <h2 class="font-black text-xl mb-6">HISTORIAL MAESTRO</h2>
            <div id="tablaHistorial" class="divide-y divide-slate-100"></div>
        </section>

        <div class="text-center">
            <input type="password" oninput="validarAdmin(this.value)" placeholder=" ACCESO ADMIN" class="bg-transparent text-[10px] text-slate-300 text-center outline-none uppercase tracking-[0.5em]">
        </div>
    </div>

    <script>
        // CONFIGURACIN INICIAL
        const DB_URL = "https://texcomercial-devo-default-rtdb.firebaseio.com/config"; // <--- PEGA TU LINK DE FIREBASE AQU
        const LOGO_BASE64 = "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"; // <--- PEGA TU LOGO AQU
        let contadorGlobal = 0;
        let registrosLocales = {};
        let editandoId = null;

        window.onload = async () => {
            document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('fechaActual').innerText = new Date().toLocaleDateString();
            await sincronizarContador();
        };

        async function sincronizarContador() {
            try {
                const r = await fetch(`${DB_URL}/config/ultimo_id.json`);
                const id = await r.json();
                contadorGlobal = id || 0;
                document.getElementById('consecutivoDisplay').innerText = `DEV-${String(contadorGlobal + 1).padStart(4, '0')}`;
            } catch (e) {}
        }

        // LGICA DE CMARA Y COMPRESIN
        function procesarFoto(input) {
            const preview = input.closest('div').querySelector('.img-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_W = 400;
                        const scale = MAX_W / img.width;
                        canvas.width = MAX_W;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressed = canvas.toDataURL('image/jpeg', 0.7);
                        preview.src = compressed;
                        preview.dataset.base64 = compressed;
                        preview.classList.remove('hidden');
                    };
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function agregarFila() {
            const row = document.querySelector('.item-fila').cloneNode(true);
            row.querySelectorAll('input').forEach(i => i.value = (i.type === 'number' ? '1' : ''));
            const p = row.querySelector('.img-preview');
            p.src = ""; p.dataset.base64 = ""; p.classList.add('hidden');
            document.getElementById('cuerpoTabla').appendChild(row);
        }

        function eliminarFila(btn) { if(document.querySelectorAll('.item-fila').length > 1) btn.closest('tr').remove(); }

        // GUARDADO Y PDF
        async function guardarRegistro() {
            const btn = document.getElementById('btnGuardar');
            const cliente = document.getElementById('cliente').value;
            if(!cliente) return alert("Por favor, ingrese el Cliente");

            btn.disabled = true; btn.innerText = "PROCESANDO...";

            const datos = {
                numero: editandoId ? registrosLocales[editandoId].numero : `DEV-${String(contadorGlobal + 1).padStart(4, '0')}`,
                cliente: cliente.toUpperCase(),
                ruc: document.getElementById('ruc').value,
                ciudad: document.getElementById('ciudad').value,
                direccion: document.getElementById('direccion').value,
                vendedor: document.getElementById('vendedor').value,
                fecha: document.getElementById('fecha').value,
                articulos: Array.from(document.querySelectorAll('.item-fila')).map(f => ({
                    cod: f.querySelectorAll('input')[0].value,
                    art: f.querySelectorAll('input')[1].value,
                    cant: f.querySelectorAll('input')[2].value,
                    motivo: f.querySelectorAll('select')[0].value,
                    empaque: f.querySelectorAll('select')[1].value,
                    foto: f.querySelector('.img-preview').dataset.base64 || null,
                    factura: f.querySelectorAll('input')[3].value
                }))
            };

            try {
                if(editandoId) {
                    await fetch(`${DB_URL}/registros/${editandoId}.json`, { method: 'PATCH', body: JSON.stringify(datos) });
                } else {
                    await fetch(`${DB_URL}/registros.json`, { method: 'POST', body: JSON.stringify(datos) });
                    await fetch(`${DB_URL}/config.json`, { method: 'PATCH', body: JSON.stringify({ ultimo_id: contadorGlobal + 1 }) });
                }
                generarPDF(datos);
                alert("Operaci贸n Exitosa");
                location.reload();
            } catch (e) { alert("Error de conexi贸n"); btn.disabled = false; }
        }

        function generarPDF(d) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Encabezado Corporativo
            try { doc.addImage(LOGO_BASE64, 'PNG', 15, 10, 35, 15); } catch(e) {}
            doc.setFontSize(14).setFont("helvetica","bold").text("TEXCOMERCIAL S.A.", 55, 18);
            doc.setFontSize(8).setFont("helvetica","normal").text("Acta de Devoluci贸n de Mercader铆a", 55, 23);
            
            doc.setDrawColor(37, 99, 235).rect(145, 10, 50, 15);
            doc.setFontSize(11).text(d.numero, 158, 20);

            // Informaci贸n
            doc.setFontSize(8).setTextColor(100);
            doc.text(`CLIENTE: ${d.cliente}`, 15, 40);
            doc.text(`DIRECCIN: ${d.direccion.toUpperCase()}`, 15, 45);
            doc.text(`VENDEDOR: ${d.vendedor}`, 145, 40);
            doc.text(`FECHA: ${d.fecha}`, 145, 45);

            // Tabla
            doc.autoTable({
                startY: 55,
                head: [['COD', 'DESCRIPCIN', 'CANT', 'MOTIVO', 'EMPAQUE', 'FOTO', 'FACT']],
                body: d.articulos.map(a => [a.cod, a.art, a.cant, a.motivo, a.empaque, '', a.factura]),
                didDrawCell: (data) => {
                    if (data.section === 'body' && data.column.index === 5) {
                        const img = d.articulos[data.row.index].foto;
                        if (img) doc.addImage(img, 'JPEG', data.cell.x + 2, data.cell.y + 1, 8, 8);
                    }
                },
                headStyles: { fillStyle: [30, 41, 59] },
                styles: { fontSize: 7, valign: 'middle' }
            });

            // Firmas
            const yFirmas = doc.lastAutoTable.finalY + 30;
            doc.line(15, yFirmas, 60, yFirmas); doc.text("EMITIDO POR", 28, yFirmas + 5);
            doc.line(80, yFirmas, 125, yFirmas); doc.text("TRANSPORTE", 93, yFirmas + 5);
            doc.line(145, yFirmas, 190, yFirmas); doc.text("CLIENTE", 162, yFirmas + 5);

            doc.save(`${d.numero}_TEXCOMERCIAL.pdf`);
        }

        // FUNCIONES ADMIN
        function validarAdmin(v) { if(v === "TEX2026") { document.getElementById('adminPanel').classList.remove('hidden'); cargarHistorial(); } }
        
        async function cargarHistorial() {
            const r = await fetch(`${DB_URL}/registros.json`);
            registrosLocales = await r.json() || {};
            const h = document.getElementById('tablaHistorial');
            h.innerHTML = "";
            Object.keys(registrosLocales).forEach(key => {
                const d = registrosLocales[key];
                h.innerHTML += `
                    <div class="flex justify-between items-center py-4">
                        <div><p class="font-black text-blue-600">${d.numero}</p><p class="text-[10px] uppercase">${d.cliente}</p></div>
                        <div class="flex gap-2">
                            <button onclick="prepararEdicion('${key}')" class="bg-amber-500 text-white px-3 py-1 rounded-lg text-[10px] font-bold">EDITAR</button>
                            <button onclick="generarPDF(registrosLocales['${key}'])" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-[10px] font-bold">PDF</button>
                        </div>
                    </div>`;
            });
        }

        function prepararEdicion(key) {
            const d = registrosLocales[key];
            editandoId = key;
            document.getElementById('cliente').value = d.cliente;
            document.getElementById('direccion').value = d.direccion;
            document.getElementById('btnGuardar').innerText = "ACTUALIZAR REGISTRO";
            document.getElementById('btnCancelar').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>